name: Update Blink Eye Cask

on:
  schedule:
    # Runs 4 times a day
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch: # Allows manual execution

jobs:
  update-cask:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Latest Release Info
        id: release
        run: |
          curl -s https://api.github.com/repos/nomandhoni-cs/blink-eye/releases/latest > release.json
          echo "Release data fetched:"
          cat release.json

          # Extract tag name and remove the 'v' prefix
          TAG_NAME=$(jq -r '.tag_name' release.json | sed 's/^v//')
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

          # Extract URLs for ARM and x64 binaries
          URL_ARM=$(jq -r '.assets[] | select(.name | contains("aarch64")).browser_download_url' release.json)
          URL_INTEL=$(jq -r '.assets[] | select(.name | contains("x64")).browser_download_url' release.json)

          # Validate the URLs
          if [[ -z "$URL_ARM" || -z "$URL_INTEL" ]]; then
            echo "Error: Unable to fetch one or both of the asset URLs."
            exit 1
          fi

          echo "URL_ARM=$URL_ARM" >> $GITHUB_ENV
          echo "URL_INTEL=$URL_INTEL" >> $GITHUB_ENV

      - name: Calculate SHA256 Checksums
        id: sha256
        run: |
          curl -L -o BlinkEye_aarch64.tar.gz "$URL_ARM"
          curl -L -o BlinkEye_x64.tar.gz "$URL_INTEL"

          # Validate downloads
          if [[ ! -f "BlinkEye_aarch64.tar.gz" || ! -f "BlinkEye_x64.tar.gz" ]]; then
            echo "Error: One or both files failed to download."
            exit 1
          fi

          # Calculate SHA256
          SHA256_ARM=$(sha256sum BlinkEye_aarch64.tar.gz | awk '{print $1}')
          SHA256_INTEL=$(sha256sum BlinkEye_x64.tar.gz | awk '{print $1}')

          echo "SHA256_ARM=$SHA256_ARM" >> $GITHUB_ENV
          echo "SHA256_INTEL=$SHA256_INTEL" >> $GITHUB_ENV

      - name: Update Cask File
        run: |
          sed -i "s/^  version \".*\"/  version \"$TAG_NAME\"/" Casks/blinkeye.rb
          sed -i "s/^  sha256 arm:   \".*\"/  sha256 arm:   \"$SHA256_ARM\"/" Casks/blinkeye.rb
          sed -i "s/^         intel: \".*\"/         intel: \"$SHA256_INTEL\"/" Casks/blinkeye.rb
          sed -i "s|^  url .*|  url \"https://github.com/nomandhoni-cs/blink-eye/releases/download/v#{version}/Blink.Eye_#{arch}.app.tar.gz\",|" Casks/blinkeye.rb

      - name: Commit and Push Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Casks/blinkeye.rb
          git commit -m "Update Blink Eye Cask to v$TAG_NAME"
          git push origin main
